# 마인크래프트 패널 시스템 리팩토링 제안서

## 📋 1. 개요

본 문서는 현재 마인크래프트 패널 시스템(Backend, Wings)의 아키텍처를 분석하고, 시스템의 안정성, 확장성, 유지보수성 및 보안을 극대화하기 위한 구체적인 리팩토링 계획을 제안합니다.

현재 시스템은 모듈화가 잘 되어 있고 각 서비스의 역할이 명확하게 정의되어 있는 강점이 있습니다. 본 제안은 이러한 강점을 기반으로, 프로덕션 환경에서 발생할 수 있는 잠재적 문제들을 사전에 해결하고 기술적으로 한 단계 더 발전시키는 데 목표를 둡니다.

## 🎯 2. 리팩토링 목표

- **안정성 및 신뢰성 강화**: 단일 장애점(SPOF)을 제거하고, 서비스 간 통신 오류 발생 시 데이터 유실을 방지합니다.
- **보안 강화**: 허가되지 않은 접근으로부터 내부 서비스 통신을 완벽하게 보호합니다.
- **확장성 확보**: 향후 다중 노드(Wings) 구성이나 기능 확장에 유연하게 대응할 수 있는 구조를 마련합니다.
- **유지보수성 및 개발 효율성 향상**: 코드의 표준을 준수하고, 테스트 자동화를 통해 변경에 대한 신뢰도��� 높입니다.

## 🛠️ 3. 영역별 리팩토링 제안

### 3.1. Wings: 상태 관리 및 동기화 (우선순위: 최우선)

#### 3.1.1. 상태 저장소 교체: 인메모리 → Redis

- **현황**: `server.store.js`가 인메모리 객체를 사용하여 서버 상태를 관리합니다. 이는 Wings 프로세스 재시작 시 모든 상태 정보가 유실되는 치명적인 단일 장애점(SPOF)입니다.
- **제안**: 서버 상태 관리의 주 저장소를 **Redis**로 교체합니다.
- **구현 방안**:
    1. `ioredis` 또는 `redis` 라이브러리를 `wings` 프로젝트에 추가합니다.
    2. `server.store.js`의 로직을 Redis의 Hash 또는 String 자료구조를 사용하도록 변경합니다. (예: `HSET server:<id> status running`)
    3. Wings 시작 시 Redis 연결을 확인하고, 기존 데이터를 로드하는 로직을 추가합니다.
- **기대 효과**:
    - **데이터 영속성**: Wings 재시작에도 서버 상태가 보존되어 데이터 정합성이 유지됩니다.
    - **확장성 기반 마련**: 향후 다중 Wings 노드 구성 시 중앙 Redis를 통해 상태를 공유할 수 있습니다.

#### 3.1.2. 동기화 방식 개선: Polling → Event-driven

- **현황**: `syncUtils.js`가 주기적으로 Docker 컨테이너와 디렉토리를 스캔(Polling)하여 Panel과 동기화합니다. 이는 비효율적이며 실시간성이 떨어집니다.
- **제안**: Docker의 **Events API (`docker events`)**를 활용하여 이벤트 기반(Event-driven) 동기화로 전환합니다.
- **구현 방안**:
    1. Wings 시작 시 `docker.getEvents()`를 통해 Docker 이벤트 스트림에 연결합니다.
    2. `start`, `stop`, `die`, `destroy` 등 컨테이너 상태 변경 이벤트를 실시간으로 감지합니다.
    3. 이벤트 발생 시, 해당 컨테이너의 정보만 즉시 Panel로 전송합니다.
- **기대 효과**:
    - **실시간성 및 효율성**: 불필요한 스캔 작업을 제거하고, 상태 변경을 지연 없이 Panel에 전송합니다.
    - **코드 단순화**: 복잡한 스캔 및 비교 로직을 이벤트 핸들러로 대체하여 코드를 단순화합니다.

### 3.2. 시스템 전반: 보안 및 테스트 (우선순위: 최우선)

#### 3.2.1. 서비스 간 통신 인증 강화

- **현황**: Panel ↔ Wings 간 API 통신에 대한 인증 메커니즘이 정의되어 있지 않아 심각한 보안 취약점이 존재합니다.
- **제안**: 공유 비밀키(API Key) 또는 내부용 JWT(m2m Token)를 도입하여 서비스 간 통신을 보호합니다.
- **구현 방안**:
    1. 환경변수(`INTERNAL_API_KEY`)에 강력한 공유 비밀키를 설정합니다.
    2. Panel에서 Wings로 API 요청 시 `Authorization: Bearer <API_KEY>` 헤더를 추가합니다.
    3. Wings의 모든 API 엔드포인트에 해당 헤더를 검증하는 미들웨어를 추가합니다. (Wings → Panel 통신에도 동일하게 적용)
- **기대 효과**:
    - **보안**: 허가되지 않은 요청으로부터 내부 API를 완벽하게 보호하여 시스템 전체의 보안 수준을 향상시킵니다.

#### 3.2.2. 통합 테스트 전략 수립

- **현황**: 시스템의 핵심 흐름(서버 생성, 제어, 동기화)을 자동으로 검증하는 통합 테스트가 부재합니다.
- **제안**: `docker-compose`를 활용하여 실제와 유사한 통합 테스트 환경을 구축하고, 핵심 시나리오를 테스트합니다.
- **구현 방안**:
    1. `docker-compose.test.yml` 파일을 작성하여 테스트용 DB, Backend, Wings 컨테이너를 정의합니다.
    2. `jest` 또는 `mocha`를 사용하여 테스트 스위트를 작성합니다.
    3. 테스트 실행 시 `docker-compose`로 환경을 구축하고, API를 호출하여 예상대로 동작하는지(DB 상태, 컨테이너 상태) 검증 후 환경을 정리합니다.
- **기대 효과**:
    - **신뢰성**: 주요 기능 변경 시 발생할 수 있는 잠재적 버그를 사전에 발견하여 배포 안정성을 높입니다.

### 3.3. Backend: 데이터���이스 및 외부 연동 (우선순위: 높음)

#### 3.3.1. 데이터베이스 스키마 관리 현대화

- **현황**: 개발 환경에서 `synchronize: true` 옵션을 사용하여 스키마를 동기화하고 있습니다. 이는 운영 환경에서 데이터 유실의 위험이 있습니다.
- **제안**: **TypeORM 마이그레이션** 기능을 도입하여 DB 스키마 변경을 안전하고 체계적으로 관리합니다.
- **구현 방안**:
    1. `ormconfig.js` 또는 `DataSource` 설정에 마이그레이션 경로를 추가합니다.
    2. `typeorm migration:generate` 명령어로 엔티티 변경 사항에 대한 마이그레이션 파일을 생성합니다.
    3. 배포 파이프라인에 `typeorm migration:run` 명령어를 추가하여 스키마를 안전하게 업데이트합니다.
- **기대 효과**:
    - **안정성**: 프로덕션 데이터베이스 스키마를 버전 관리하며 안전하게 변경할 수 있습니다.

#### 3.3.2. 서비스 간 통신 안정성 확보

- **현황**: `WingsService`가 HTTP 요청 로직을 직접 처리하며, Wings의 일시적인 장애에 취약합니다.
- **제안**: NestJS의 `@nestjs/axios` (`HttpModule`)를 도입하고, **재시도(Retry) 및 서킷 브레이커(Circuit Breaker)** 패턴을 적용합니다.
- **구현 방안**:
    1. `WingsModule`에 `HttpModule`을 등록��고, `WingsService`에 `HttpService`를 주입받도록 변경합니다.
    2. `axios-retry`와 같은 라이브러리나 NestJS 인터셉터를 사용하여 재시도 로직을 구현합니다.
    3. 서킷 브레이커 패턴을 적용하여 Wings 장애 시 불필요한 요청을 차단하고 빠른 실패를 유도합니다.
- **기대 효과**:
    - **안정성 및 유지보수성**: 외부 서비스 장애가 시스템 전체로 전파되는 것을 막고, API 연동 코드를 표준화합니다.

#### 3.3.3. 동기화 아키텍처 개선

- **현황**: Wings가 백엔드의 API를 직접 호출하는 동기식 구조로, 백엔드 장애 시 상태 변경 이벤트를 유실할 수 있습니다.
- **제안**: **메시지 큐(Message Queue)** (예: RabbitMQ, Redis Pub/Sub)를 도입하여 비동기 처리 방식으로 전환합니다.
- **구현 방안**:
    1. `@nestjs/bull` 모듈을 사용하여 Redis 기반의 메시지 큐를 설정합니다.
    2. Wings는 상태 변경 시 Panel API를 호출하는 대신, 메시지 큐에 작업을 게시(publish)합니다.
    3. 백엔드는 큐를 구독(subscribe)하고, 작업을 받아 비동기적으로 DB를 업데이트합니다.
- **기대 효과**:
    - **신뢰성 및 응답성**: 서비스 간 결합도를 낮춰 메시지 유실 없는 안정적인 동기화를 보장하고, API 응답 시간을 단축합니다.

## 📊 4. 제안 요약 및 우선순위

| 우선순위 | 영역 | 제안 내용 | 기대 효과 |
| :--- | :--- | :--- | :--- |
| **최우선** | Wings | 인메모리 스토어 → **Redis로 교체** | 안정성, 데이터 정합성 |
| **최우선** | 전반 | **서비스 간 통신 인증 강화** | 보안 |
| **높음** | Backend | 동기식 API → **메시지 큐 도입** | 안정성, 신뢰성, 응답성 |
| **높음** | Wings | 주기적 스캔 → **Docker 이벤트 기반으로 전환** | 효율성, 실시간성 |
| **높음** | Backend | `synchronize:true` → **TypeORM 마이그레이션 도입** | 안정성 |
| **중간** | 전반 | **Wings 테스트 및 통합 테스트 환경 구축** | 신뢰성, 유지보수성 |
| **중간** | Backend | 직접 구현 → **NestJS `HttpModule` + Resilience 패턴** | 유지보수성, 안정성 |

## 🚀 5. 다음 단계

본 제안서의 내용을 바탕으로 우선순위가 높은 항목부터 실제 리팩토링 작업을 시작하는 것을 권장합니다. 각 항목에 대한 구체적인 기술 검토 및 구현 계획을 수립하여 점진적으로 시스템을 개선해 나갈 수 있습니다.
